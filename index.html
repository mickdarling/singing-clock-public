<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Singing Clock - Convergence Countdown</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.1.0/dist/chartjs-plugin-annotation.min.js"></script>
<style>
  :root {
    --bg: #0d1117;
    --surface: #161b22;
    --border: #30363d;
    --text: #e6edf3;
    --text-dim: #8b949e;
    --teal: #4ecdc4;
    --red: #ff6b6b;
    --yellow: #ffd93d;
    --purple: #b380ff;
    --blue: #58a6ff;
    --grid: #21262d;
  }

  [data-theme="light"] {
    --bg: #ffffff;
    --surface: #f6f8fa;
    --border: #d0d7de;
    --text: #1f2328;
    --text-dim: #656d76;
    --teal: #1a7f76;
    --red: #cf222e;
    --yellow: #9a6700;
    --purple: #8250df;
    --blue: #0969da;
    --grid: #d8dee4;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  .skip-link {
    position: absolute;
    top: -100%;
    left: 1rem;
    background: var(--teal);
    color: #000;
    padding: 0.5rem 1rem;
    border-radius: 0 0 6px 6px;
    z-index: 2000;
    font-size: 0.85rem;
    text-decoration: none;
  }

  .skip-link:focus { top: 0; }

  :focus-visible {
    outline: 2px solid var(--teal);
    outline-offset: 2px;
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'SF Mono', 'Fira Code', 'JetBrains Mono', monospace;
    min-height: 100vh;
    padding: 2rem;
  }

  .hero {
    text-align: center;
    padding: 3rem 1rem;
    border-bottom: 1px solid var(--border);
    margin-bottom: 2rem;
  }

  .hero h1 {
    font-size: 1.2rem;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.3em;
    margin-bottom: 1rem;
  }

  .countdown {
    font-size: 5rem;
    font-weight: 700;
    color: var(--teal);
    line-height: 1;
    margin-bottom: 0.5rem;
  }

  .countdown-label {
    font-size: 1rem;
    color: var(--text-dim);
    margin-bottom: 1.5rem;
  }

  .countdown-detail {
    font-size: 2rem;
    color: var(--yellow);
    margin-bottom: 0.5rem;
  }

  .meta-stats {
    display: flex;
    justify-content: center;
    gap: 3rem;
    margin-top: 2rem;
    flex-wrap: wrap;
  }

  .stat {
    text-align: center;
  }

  .stat-value {
    font-size: 1.8rem;
    font-weight: 700;
  }

  .stat-label {
    font-size: 0.75rem;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }

  .help-hint {
    cursor: help;
    border-bottom: 1px dotted var(--text-dim);
  }

  .chart-subtitle {
    font-size: 0.7rem;
    color: var(--text-dim);
    font-weight: 400;
    text-transform: none;
    letter-spacing: 0;
    margin-top: 0.25rem;
  }

  .help-modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }

  .help-modal-overlay.active { display: flex; }

  .help-modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 2rem;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    color: var(--text);
  }

  .help-modal h2 {
    font-size: 1.1rem;
    color: var(--teal);
    margin-bottom: 1.25rem;
    text-transform: none;
    letter-spacing: 0;
  }

  .help-modal dl {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 0.5rem 1rem;
    font-size: 0.8rem;
  }

  .help-modal dt {
    color: var(--text);
    font-weight: 700;
    white-space: nowrap;
  }

  .help-modal dd {
    color: var(--text-dim);
    line-height: 1.5;
  }

  .help-modal .close-btn {
    float: right;
    background: none;
    border: none;
    color: var(--text-dim);
    font-size: 1.2rem;
    cursor: pointer;
    padding: 0.25rem;
  }

  .help-modal .close-btn:hover { color: var(--text); }

  .controls {
    max-width: 1400px;
    margin: 0 auto 1.5rem;
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
    align-items: center;
  }

  .btn {
    background: var(--surface);
    color: var(--text);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 0.5rem 1.25rem;
    font-family: inherit;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn:hover { border-color: var(--teal); color: var(--teal); }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; }
  .btn:disabled:hover { border-color: var(--border); color: var(--text); }

  .btn-primary {
    background: var(--teal);
    color: var(--bg);
    border-color: var(--teal);
    font-weight: 700;
  }

  .btn-primary:hover { background: #3dbdb5; }
  .btn-primary:disabled { background: var(--border); border-color: var(--border); color: var(--text-dim); }

  .theme-toggle {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 0.4rem 0.6rem;
    cursor: pointer;
    font-size: 1rem;
    line-height: 1;
    transition: all 0.2s;
    min-height: 44px;
    min-width: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .theme-toggle:hover { border-color: var(--teal); }

  .export-dropdown {
    position: relative;
    display: inline-block;
  }

  .export-menu {
    display: none;
    position: absolute;
    right: 0;
    top: 100%;
    margin-top: 0.25rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    min-width: 160px;
    z-index: 100;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  }

  .export-menu.active { display: block; }

  .export-menu button {
    display: block;
    width: 100%;
    padding: 0.6rem 1rem;
    background: none;
    border: none;
    color: var(--text);
    font-family: inherit;
    font-size: 0.8rem;
    text-align: left;
    cursor: pointer;
  }

  .export-menu button:hover {
    background: var(--bg);
    color: var(--teal);
  }

  .export-menu button + button {
    border-top: 1px solid var(--border);
  }

  .scoring-toggles {
    display: none;
    max-width: 1400px;
    margin: 0 auto 1rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.75rem 1.25rem;
    font-size: 0.8rem;
    align-items: center;
    gap: 1.25rem;
    flex-wrap: wrap;
  }

  .scoring-toggles.active { display: flex; }

  .scoring-toggles .toggle-label {
    color: var(--text-dim);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    white-space: nowrap;
  }

  .scoring-toggle {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    cursor: pointer;
    user-select: none;
  }

  .scoring-toggle input[type="checkbox"] {
    accent-color: var(--teal);
    width: 16px;
    height: 16px;
  }

  .scoring-toggle .swatch {
    display: inline-block;
    width: 12px;
    height: 3px;
    border-radius: 2px;
    vertical-align: middle;
  }

  .scoring-toggle .swatch-enriched { background: var(--teal); }
  .scoring-toggle .swatch-regex { background: var(--yellow); border-style: dashed; }

  .issue-impact-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.8rem;
  }

  .issue-impact-table th {
    text-align: left;
    padding: 0.5rem 0.75rem;
    color: var(--text-dim);
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
  }

  .issue-impact-table td {
    padding: 0.5rem 0.75rem;
    border-bottom: 1px solid var(--border);
    color: var(--text);
    vertical-align: top;
  }

  .issue-impact-table tr:last-child td { border-bottom: none; }

  .issue-impact-table .rank { color: var(--text-dim); font-weight: 700; width: 2rem; text-align: center; }
  .issue-impact-table .impact { font-weight: 700; white-space: nowrap; }
  .issue-impact-table .impact.positive { color: var(--teal); }
  .issue-impact-table .impact.neutral { color: var(--text-dim); }
  .issue-impact-table .score { color: var(--yellow); white-space: nowrap; }
  .issue-impact-table .issue-title { max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .issue-impact-table .repo-name { color: var(--text-dim); font-size: 0.7rem; }
  .issue-impact-table .cats { font-size: 0.7rem; color: var(--text-dim); }
  .issue-impact-table .cat-tag {
    display: inline-block;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 3px;
    padding: 0.1rem 0.35rem;
    margin: 0.1rem;
    font-size: 0.65rem;
  }

  .scan-status {
    font-size: 0.75rem;
    color: var(--text-dim);
  }

  .scan-status.running { color: var(--yellow); }
  .scan-status.done { color: var(--teal); }
  .scan-status.error { color: var(--red); }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
  .scanning { animation: pulse 1.5s ease-in-out infinite; }

  .charts {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    max-width: 1400px;
    margin: 0 auto;
  }

  .chart-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1.5rem;
  }

  .chart-card h2 {
    font-size: 0.85rem;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 1rem;
  }

  .chart-container {
    position: relative;
    height: 280px;
  }

  .progress-bar-container {
    max-width: 1400px;
    margin: 0 auto 2rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1.5rem;
  }

  .progress-bar-container h2 {
    font-size: 0.85rem;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 1rem;
  }

  .progress-bar {
    height: 32px;
    background: var(--bg);
    border-radius: 16px;
    overflow: hidden;
    position: relative;
  }

  .progress-fill {
    height: 100%;
    border-radius: 16px;
    background: linear-gradient(90deg, var(--teal), var(--blue));
    transition: width 1s ease;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding-right: 12px;
    font-size: 0.8rem;
    font-weight: 700;
  }

  .progress-markers {
    display: flex;
    justify-content: space-between;
    margin-top: 0.5rem;
    font-size: 0.7rem;
    color: var(--text-dim);
  }

  .footer {
    text-align: center;
    padding: 2rem;
    color: var(--text-dim);
    font-size: 0.75rem;
    border-top: 1px solid var(--border);
    margin-top: 2rem;
    max-width: 1400px;
    margin-left: auto;
    margin-right: auto;
  }

  .error {
    text-align: center;
    padding: 4rem;
    color: var(--red);
    font-size: 1.2rem;
  }

  .scan-error-details {
    max-width: 800px;
    margin: 1rem auto 0;
    text-align: left;
  }

  .scan-error-details summary {
    cursor: pointer;
    color: var(--text-dim);
    font-size: 0.75rem;
    text-align: center;
    padding: 0.5rem;
  }

  .scan-error-details summary:hover { color: var(--text); }

  .scan-log-output {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 1rem;
    margin-top: 0.5rem;
    font-size: 0.7rem;
    color: var(--text-dim);
    max-height: 300px;
    overflow-y: auto;
    white-space: pre-wrap;
    word-break: break-word;
  }

  /* Onboarding / Empty State */
  .onboarding {
    max-width: 700px;
    margin: 0 auto;
    text-align: center;
    padding: 2rem 1rem 3rem;
  }

  .onboarding h2 {
    font-size: 1.6rem;
    color: var(--teal);
    margin-bottom: 0.5rem;
    font-weight: 600;
  }

  .onboarding .tagline {
    color: var(--text-dim);
    font-size: 0.95rem;
    margin-bottom: 2.5rem;
  }

  .onboarding-steps {
    text-align: left;
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
    margin-bottom: 2.5rem;
  }

  .onboarding-step {
    display: flex;
    gap: 1rem;
    align-items: flex-start;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1rem 1.25rem;
  }

  .step-number {
    flex-shrink: 0;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: var(--teal);
    color: var(--bg);
    font-weight: 700;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-top: 2px;
  }

  .step-content h3 {
    font-size: 0.95rem;
    margin-bottom: 0.35rem;
    color: var(--text);
  }

  .step-content p {
    font-size: 0.8rem;
    color: var(--text-dim);
    line-height: 1.5;
  }

  .step-content code {
    background: var(--bg);
    padding: 0.15em 0.4em;
    border-radius: 3px;
    font-size: 0.8rem;
    color: var(--yellow);
  }

  .onboarding-actions {
    display: flex;
    gap: 0.75rem;
    justify-content: center;
    flex-wrap: wrap;
  }

  .onboarding-actions .btn-primary {
    font-size: 1rem;
    padding: 0.75rem 2rem;
  }

  .onboarding-status {
    margin-top: 1.5rem;
    font-size: 0.8rem;
    color: var(--text-dim);
    min-height: 1.2em;
  }

  .fade-in {
    animation: fadeIn 0.4s ease-in;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Tablet landscape and smaller */
  @media (max-width: 900px) {
    .charts { grid-template-columns: 1fr; }
    .countdown { font-size: 3rem; }
    .countdown-detail { font-size: 1.5rem; }
  }

  /* Tablet portrait */
  @media (max-width: 768px) {
    body { padding: 1rem; }

    .hero { padding: 2rem 0.75rem; }
    .hero h1 { font-size: 1rem; letter-spacing: 0.2em; }

    .meta-stats { gap: 1.5rem; }
    .stat-value { font-size: 1.4rem; }
    .stat-label { font-size: 0.65rem; }

    .controls { flex-wrap: wrap; justify-content: center; }

    .btn { padding: 0.6rem 1.25rem; min-height: 44px; min-width: 44px; }

    .chart-card { padding: 1rem; }
    .chart-card h2 { font-size: 0.8rem; }
    .chart-container { height: 240px; }

    .progress-bar-container { padding: 1rem; }
    .progress-markers { font-size: 0.6rem; }
    .progress-markers span:nth-child(2) { display: none; }

    .footer { font-size: 0.65rem; padding: 1.5rem 0.5rem; }

    .onboarding { padding: 1.5rem 0.5rem 2rem; }
    .onboarding h2 { font-size: 1.3rem; }
    .onboarding-step { padding: 0.85rem 1rem; }
  }

  /* Phone */
  @media (max-width: 480px) {
    body { padding: 0.5rem; }

    .hero { padding: 1.5rem 0.5rem; margin-bottom: 1rem; }
    .hero h1 { font-size: 0.85rem; letter-spacing: 0.15em; margin-bottom: 0.5rem; }

    .countdown { font-size: 2.5rem; }
    .countdown-label { font-size: 0.8rem; margin-bottom: 1rem; }
    .countdown-detail { font-size: 1.2rem; }

    .meta-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-top: 1.5rem;
    }
    .meta-stats .stat:last-child {
      grid-column: 1 / -1;
    }
    .stat-value { font-size: 1.2rem; }

    .controls {
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .btn { font-size: 0.75rem; padding: 0.6rem 1rem; }
    .scan-status { width: 100%; text-align: center; order: -1; }

    .chart-container { height: 200px; }
    .charts { gap: 1rem; }

    .progress-bar { height: 24px; }
    .progress-fill { font-size: 0.7rem; padding-right: 8px; }
    .progress-markers span:nth-child(3) { display: none; }

    .footer { word-break: break-word; }

    .onboarding h2 { font-size: 1.1rem; }
    .onboarding .tagline { font-size: 0.85rem; margin-bottom: 1.5rem; }
    .onboarding-steps { gap: 1rem; }
    .onboarding-step { flex-direction: column; gap: 0.5rem; padding: 0.75rem; }
    .step-number { width: 24px; height: 24px; font-size: 0.75rem; }
    .onboarding-actions .btn-primary { width: 100%; }
  }
</style>
</head>
<body>
<script>
// Apply theme immediately to prevent flash of wrong theme
(function() {
  const saved = localStorage.getItem('singing-clock-theme');
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  const theme = saved || (prefersDark ? 'dark' : 'light');
  if (theme === 'light') document.documentElement.setAttribute('data-theme', 'light');
})();
</script>

<a href="#main-content" class="skip-link">Skip to main content</a>

<header class="hero">
  <h1>Singing Clock</h1>
  <div class="countdown" id="countdown-days" aria-live="polite">---</div>
  <div class="countdown-label">days until graduation</div>
  <div class="countdown-detail" id="countdown-full" aria-label="Detailed countdown timer">--d --h --m --s</div>
  <div id="convergence-date" style="color: var(--text-dim); font-size: 0.9rem;"></div>
  <div class="meta-stats" role="group" aria-label="Key metrics">
    <div class="stat">
      <div class="stat-value" style="color: var(--teal);" id="stat-capability">--</div>
      <div class="stat-label"><span class="help-hint" title="Logistic-model % of maximum capability reached">Self-Sufficiency</span></div>
    </div>
    <div class="stat">
      <div class="stat-value" style="color: var(--yellow);" id="stat-sophistication">--</div>
      <div class="stat-label"><span class="help-hint" title="Ratio of high-weight categories to total activity">Sophistication</span></div>
    </div>
    <div class="stat">
      <div class="stat-value" style="color: var(--red);" id="stat-commits">--</div>
      <div class="stat-label"><span class="help-hint" title="Total scored commits across all scanned repos">Total Commits</span></div>
    </div>
    <div class="stat">
      <div class="stat-value" style="color: var(--purple);" id="stat-repos">--</div>
      <div class="stat-label"><span class="help-hint" title="Number of git repositories included in the scan">Repos Scanned</span></div>
    </div>
    <div class="stat">
      <div class="stat-value" style="color: var(--blue);" id="stat-day">--</div>
      <div class="stat-label"><span class="help-hint" title="Days elapsed since the first scored commit">Day of Project</span></div>
    </div>
  </div>
</header>

<nav class="controls" aria-label="Dashboard controls">
  <span class="scan-status" id="scan-status" aria-live="polite"></span>
  <button class="btn-primary btn" id="btn-scan" onclick="triggerScan()">Rescan Repos</button>
  <button class="btn" onclick="location.reload()">Refresh</button>
  <button class="theme-toggle" id="theme-toggle" onclick="toggleTheme()" title="Toggle light/dark theme" aria-label="Toggle light/dark theme"></button>
  <button class="btn" onclick="openGlossary()" title="Terminology guide">? Help</button>
  <div class="export-dropdown">
    <button class="btn" onclick="toggleExportMenu()" id="btn-export" disabled>Export</button>
    <div class="export-menu" id="export-menu">
      <button onclick="exportCSV()">CSV (monthly data)</button>
      <button onclick="exportJSON()">JSON (full scan)</button>
    </div>
  </div>
</nav>

<main id="main-content">

<div class="scoring-toggles" id="scoring-toggles" aria-label="Scoring overlay controls">
  <span class="toggle-label">Scoring overlay:</span>
  <label class="scoring-toggle">
    <input type="checkbox" id="toggle-enriched" checked onchange="updateScoringOverlays()">
    <span class="swatch swatch-enriched"></span> LLM Enriched
  </label>
  <label class="scoring-toggle">
    <input type="checkbox" id="toggle-regex" checked onchange="updateScoringOverlays()">
    <span class="swatch swatch-regex"></span> Regex Only
  </label>
  <span style="color: var(--text-dim); font-size: 0.7rem; margin-left: auto;">Scoring mode: <strong id="scoring-mode-label">--</strong></span>
</div>

<section class="progress-bar-container" aria-label="Capability progress">
  <h2>Capability Progress</h2>
  <div class="chart-subtitle">Logistic model fit: current % of predicted maximum capability</div>
  <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" aria-label="Capability progress" id="progress-bar">
    <div class="progress-fill" id="progress-fill" style="width: 0%;">0%</div>
  </div>
  <div class="progress-markers">
    <span>0% - Inception</span>
    <span>50%</span>
    <span>95% - Self-Sufficient</span>
    <span>100%</span>
  </div>
</section>

<section class="drift-container" id="drift-section" style="display:none;" aria-label="Convergence date drift">
  <div class="chart-card" style="max-width:1400px; margin:0 auto 1.5rem;">
    <h2>Convergence Date Drift</h2>
    <div class="chart-subtitle">How the predicted graduation date shifts over successive scans</div>
    <div class="chart-container" style="height: 300px;"><canvas id="chart-drift" role="img" aria-label="Convergence date drift chart showing prediction changes over time"></canvas></div>
    <div id="drift-summary" style="margin-top:1rem; font-size:0.85rem; color:var(--text-dim); text-align:center;"></div>
  </div>
</section>

<section class="charts" aria-label="Data visualizations">
  <div class="chart-card">
    <h2>Commit Rate (Actual + Projected)</h2>
    <div class="chart-subtitle">Monthly commit volume with logistic projection overlay</div>
    <div class="chart-container"><canvas id="chart-commits" role="img" aria-label="Commit rate chart showing actual and projected monthly commits"></canvas></div>
  </div>
  <div class="chart-card">
    <h2>Cumulative Capability</h2>
    <div class="chart-subtitle">Running total of weighted capability score with logistic fit</div>
    <div class="chart-container"><canvas id="chart-capability" role="img" aria-label="Cumulative capability score chart with logistic model fit"></canvas></div>
  </div>
  <div class="chart-card">
    <h2>Sophistication Trend</h2>
    <div class="chart-subtitle">High-weight category ratio per month (agents, self-modify, meta)</div>
    <div class="chart-container"><canvas id="chart-sophistication" role="img" aria-label="Sophistication trend chart showing monthly high-weight category ratios"></canvas></div>
  </div>
  <div class="chart-card">
    <h2>Convergence: Effort vs. Capability</h2>
    <div class="chart-subtitle">Commit rate derivative vs. capability derivative — crossing = graduation</div>
    <div class="chart-container"><canvas id="chart-convergence" role="img" aria-label="Convergence chart comparing effort and capability derivatives"></canvas></div>
  </div>
</section>

<section class="issue-impact-section" id="issue-impact-section" style="display:none;" aria-label="Issue convergence impact">
  <div class="chart-card" style="max-width:1400px; margin:0 auto 1.5rem;">
    <h2>Open Issues by Convergence Impact</h2>
    <div class="chart-subtitle">Ranked by estimated days shifted toward graduation if completed</div>
    <div id="issue-impact-table-wrapper" style="margin-top:1rem; overflow-x:auto;"></div>
  </div>
</section>

</main>

<footer class="footer" id="footer">
  Loading data...
</footer>

<div class="help-modal-overlay" id="glossary-overlay" role="dialog" aria-modal="true" aria-label="Glossary and terminology guide">
  <div class="help-modal">
    <button class="close-btn" onclick="closeGlossary()" aria-label="Close glossary">&times;</button>
    <h2>Glossary &amp; Terminology</h2>
    <dl>
      <dt>Convergence</dt>
      <dd>The predicted date when a project becomes self-sufficient — commit rate nears zero while capability plateaus near 100%.</dd>

      <dt>Self-Sufficiency</dt>
      <dd>Percentage of maximum predicted capability reached, derived from a logistic growth model fitted to cumulative scores.</dd>

      <dt>Sophistication</dt>
      <dd>Ratio of high-weight category scores (agents, self-modify, meta) to total score. Higher values mean more advanced work.</dd>

      <dt>Capability Score</dt>
      <dd>Weighted sum across 9 categories (foundation, testing, agents, etc.). Each commit is scored by regex or LLM classification.</dd>

      <dt>Logistic Model</dt>
      <dd>S-curve (L / (1 + e^(-r(t-t_mid)))) fitted via grid search. Parameters: L (ceiling), r (growth rate), t_mid (inflection).</dd>

      <dt>Enrichment</dt>
      <dd>Optional LLM-based classification that replaces regex scoring with semantic analysis. Requires --enrich flag and API key.</dd>

      <dt>Diffstat Weighting</dt>
      <dd>Adjusts scores based on commit size — large source changes get a boost, config-only changes get reduced weight.</dd>

      <dt>Categories</dt>
      <dd>foundation (1), testing (1), integration (2), safety (2), elements (2), ecosystem (2), agents (3), meta (4), self_modify (5). Weight in parentheses.</dd>

      <dt>Graduation</dt>
      <dd>When the project reaches the convergence point — capability near ceiling and commit rate approaching zero.</dd>
    </dl>
  </div>
</div>

<script>
// ─── Globals ────────────────────────────────────────────────────────────
let DATA = null;

function cssVar(name) {
  return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
}

function getChartDefaults() {
  const dim = cssVar('--text-dim');
  const grid = cssVar('--grid');
  return {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { labels: { color: dim, font: { family: "'SF Mono', monospace", size: 11 } } },
    },
    scales: {
      x: { ticks: { color: dim, font: { size: 10 } }, grid: { color: grid } },
      y: { ticks: { color: dim, font: { size: 10 } }, grid: { color: grid } },
    },
  };
}

const CHART_DEFAULTS = getChartDefaults();

// ─── Theme Toggle ───────────────────────────────────────────────────────
function getTheme() {
  return document.documentElement.getAttribute('data-theme') === 'light' ? 'light' : 'dark';
}

function updateThemeIcon() {
  const btn = document.getElementById('theme-toggle');
  if (btn) btn.textContent = getTheme() === 'dark' ? '\u2600\uFE0F' : '\uD83C\uDF19';
}

function toggleTheme() {
  const next = getTheme() === 'dark' ? 'light' : 'dark';
  if (next === 'light') {
    document.documentElement.setAttribute('data-theme', 'light');
  } else {
    document.documentElement.removeAttribute('data-theme');
  }
  localStorage.setItem('singing-clock-theme', next);
  // Reload to re-render charts with new theme colors
  location.reload();
}

// Set icon on load
updateThemeIcon();

// ─── Glossary Modal ─────────────────────────────────────────────────────
function openGlossary() {
  document.getElementById('glossary-overlay').classList.add('active');
}
function closeGlossary() {
  document.getElementById('glossary-overlay').classList.remove('active');
}
document.getElementById('glossary-overlay').addEventListener('click', function(e) {
  if (e.target === this) closeGlossary();
});
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') closeGlossary();
});

// ─── Data Export ────────────────────────────────────────────────────────
function toggleExportMenu() {
  document.getElementById('export-menu').classList.toggle('active');
}

// Close export menu when clicking outside
document.addEventListener('click', function(e) {
  const dropdown = document.getElementById('export-menu');
  if (!dropdown) return;
  if (!e.target.closest('.export-dropdown')) {
    dropdown.classList.remove('active');
  }
});

function downloadFile(content, filename, mime) {
  const blob = new Blob([content], { type: mime });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

function exportCSV() {
  if (!DATA) return;
  const months = DATA.months || [];
  const commits = DATA.commit_counts || [];
  const scores = DATA.cumulative_scores || [];
  const soph = DATA.sophistication_ratios || [];

  let csv = 'Month,Commits,Cumulative Score,Sophistication Ratio\n';
  for (let i = 0; i < months.length; i++) {
    csv += `${months[i]},${commits[i] || 0},${scores[i] || 0},${(soph[i] || 0).toFixed(4)}\n`;
  }

  // Add metadata as comments
  const meta = [
    `# Singing Clock Export`,
    `# Generated: ${DATA.generated || 'unknown'}`,
    `# Repos: ${(DATA.repos || []).join('; ')}`,
    `# Total Commits: ${DATA.total_commits || 0}`,
    `# Convergence Date: ${DATA.models?.convergence_date || 'unknown'}`,
    ''
  ].join('\n');

  const ts = new Date().toISOString().slice(0, 10);
  downloadFile(meta + csv, `singing-clock-${ts}.csv`, 'text/csv');
  document.getElementById('export-menu').classList.remove('active');
}

function exportJSON() {
  if (!DATA) return;
  const ts = new Date().toISOString().slice(0, 10);
  downloadFile(JSON.stringify(DATA, null, 2), `singing-clock-${ts}.json`, 'application/json');
  document.getElementById('export-menu').classList.remove('active');
}


// ─── Milestone Helpers ──────────────────────────────────────────────────
// Convert a date string (YYYY-MM-DD) to a month-index relative to the timeline
function dateToMonthIndex(dateStr, epochMonth) {
  // epochMonth is [year, month] of index 0
  const d = new Date(dateStr);
  return (d.getFullYear() - epochMonth[0]) * 12 + (d.getMonth() - epochMonth[1]);
}

function makeMilestoneAnnotations(data, epochMonth, labelCount) {
  const annotations = {};
  const models = data.models || {};

  const milestones = [
    { key: 'zero', date: models.commit_rate?.zero_date, label: 'Commits ~ 0', color: '#ff6b6b' },
    { key: 'cap95', date: models.capability?.pct_95_date, label: '95%', color: '#4ecdc4' },
    { key: 'cap99', date: models.capability?.pct_99_date, label: '99%', color: '#58a6ff' },
    { key: 'soph100', date: models.sophistication?.pct_100_date, label: 'Soph 100%', color: '#b380ff' },
    { key: 'convergence', date: models.convergence_date, label: 'Convergence', color: '#ffd93d' },
  ];

  for (const m of milestones) {
    if (!m.date) continue;
    const idx = dateToMonthIndex(m.date, epochMonth);
    if (idx < 0 || idx >= labelCount) continue;

    annotations[`line_${m.key}`] = {
      type: 'line',
      xMin: idx,
      xMax: idx,
      borderColor: m.color,
      borderWidth: 2,
      borderDash: [6, 3],
      label: {
        display: true,
        content: m.label,
        position: 'start',
        backgroundColor: getTheme() === 'dark' ? 'rgba(13,17,23,0.85)' : 'rgba(255,255,255,0.85)',
        color: m.color,
        font: { family: "'SF Mono', monospace", size: 10, weight: 'bold' },
        padding: 4,
      },
    };
  }

  // 95-99% spread band
  const cap95idx = models.capability?.pct_95_date ? dateToMonthIndex(models.capability.pct_95_date, epochMonth) : null;
  const cap99idx = models.capability?.pct_99_date ? dateToMonthIndex(models.capability.pct_99_date, epochMonth) : null;
  if (cap95idx !== null && cap99idx !== null && cap95idx >= 0 && cap99idx < labelCount) {
    annotations['band_95_99'] = {
      type: 'box',
      xMin: cap95idx,
      xMax: cap99idx,
      backgroundColor: 'rgba(78, 205, 196, 0.08)',
      borderColor: 'rgba(78, 205, 196, 0.2)',
      borderWidth: 1,
      label: {
        display: true,
        content: '95-99% zone',
        position: { x: 'center', y: 'start' },
        backgroundColor: getTheme() === 'dark' ? 'rgba(13,17,23,0.85)' : 'rgba(255,255,255,0.85)',
        color: '#4ecdc4',
        font: { family: "'SF Mono', monospace", size: 9 },
        padding: 3,
      },
    };
  }

  return annotations;
}

// ─── Scan Controls ──────────────────────────────────────────────────────
async function triggerScan() {
  const btn = document.getElementById('btn-scan');
  const status = document.getElementById('scan-status');

  btn.disabled = true;
  status.className = 'scan-status running scanning';
  status.textContent = 'Scanning repos...';

  try {
    const resp = await fetch('/api/scan');
    const result = await resp.json();

    if (result.status === 'already_running') {
      status.textContent = 'Scan already in progress...';
    } else {
      status.textContent = 'Scan started, waiting for results...';
    }

    // Poll for completion
    pollForCompletion();
  } catch (e) {
    status.className = 'scan-status error';
    status.textContent = 'Error: server not running. Use python3 server.py';
    btn.disabled = false;
  }
}

async function pollForCompletion() {
  const btn = document.getElementById('btn-scan');
  const status = document.getElementById('scan-status');
  const startTime = Date.now();
  const origGenerated = DATA?.generated;

  const interval = setInterval(async () => {
    try {
      const statusResp = await fetch('/api/status');
      if (statusResp.ok) {
        const st = await statusResp.json();

        // Scan finished — check result
        if (!st.scan_running) {
          // Check if data.json was updated
          const dataResp = await fetch('data.json?t=' + Date.now());
          if (dataResp.ok) {
            const newData = await dataResp.json();
            if (newData.generated !== origGenerated) {
              clearInterval(interval);
              status.className = 'scan-status done';
              status.textContent = `Scan complete! Updated ${new Date(newData.generated).toLocaleTimeString()}`;
              btn.disabled = false;
              setTimeout(() => location.reload(), 500);
              return;
            }
          }

          // Scan stopped but data didn't update — likely a failure
          if (st.last_scan_success === false) {
            clearInterval(interval);
            await showScanFailure(status, btn);
            return;
          }
        }
      }
    } catch (e) { /* keep polling */ }

    // Timeout after 5 minutes
    if (Date.now() - startTime > 300000) {
      clearInterval(interval);
      status.className = 'scan-status error';
      status.textContent = 'Scan timed out';
      btn.disabled = false;
      await showScanLogs();
    }
  }, 2000);
}

async function showScanFailure(statusEl, btn) {
  statusEl.className = 'scan-status error';
  statusEl.textContent = 'Scan failed.';
  btn.disabled = false;
  btn.textContent = 'Retry Scan';
  await showScanLogs();
}

async function showScanLogs() {
  try {
    const resp = await fetch('/api/scan-logs');
    if (!resp.ok) return;
    const logs = await resp.json();
    if (!logs.output) return;

    // Remove existing log details if any
    const existing = document.querySelector('.scan-error-details');
    if (existing) existing.remove();

    const details = document.createElement('details');
    details.className = 'scan-error-details';
    details.innerHTML = `<summary>View scan logs</summary>` +
      `<pre class="scan-log-output">${escapeHtml(logs.output)}</pre>`;

    const controls = document.querySelector('.controls');
    controls.parentNode.insertBefore(details, controls.nextSibling);
  } catch (_) { /* no logs available */ }
}

function escapeHtml(str) {
  return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

// ─── Data Loading ───────────────────────────────────────────────────────
function validateData(data) {
  const issues = [];
  if (!data || typeof data !== 'object') return ['data.json is not a valid object'];
  if (!data.generated) issues.push('missing "generated" timestamp');
  if (!data.months || !Array.isArray(data.months)) issues.push('missing "months" array');
  if (!data.current || typeof data.current !== 'object') issues.push('missing "current" stats');
  return issues;
}

async function loadData() {
  try {
    const resp = await fetch('data.json');
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const data = await resp.json();
    const issues = validateData(data);
    if (issues.length > 0) {
      console.warn('data.json validation:', issues);
      // Partial data — still return it so we can render what we have
      data._partial = true;
      data._validationIssues = issues;
    }
    return data;
  } catch (e) {
    showOnboarding();
    throw e;
  }
}

function showOnboarding() {
  // Hide dashboard sections that have no data
  document.querySelector('.controls').style.display = 'none';
  document.querySelector('.progress-bar-container').style.display = 'none';
  document.querySelector('.charts').style.display = 'none';
  document.getElementById('footer').style.display = 'none';
  const drift = document.getElementById('drift-section');
  if (drift) drift.style.display = 'none';

  // Replace hero with onboarding
  document.querySelector('.hero').innerHTML = `
    <div class="onboarding fade-in">
      <h2>Welcome to Singing Clock</h2>
      <p class="tagline">Convergence countdown dashboard for AI-assisted software projects.<br>
        Scan your repos, track capability growth, and predict when your project reaches self-sufficiency.</p>

      <div class="onboarding-steps">
        <div class="onboarding-step">
          <div class="step-number">1</div>
          <div class="step-content">
            <h3>Configure your repos</h3>
            <p>Copy <code>config.example.json</code> to <code>config.json</code> and add the paths to
              your git repositories in the <code>scan_dirs</code> array.</p>
          </div>
        </div>
        <div class="onboarding-step">
          <div class="step-number">2</div>
          <div class="step-content">
            <h3>Run the scanner</h3>
            <p>Run <code>python3 scan.py</code> to analyze your commits and generate scoring data.
              Add <code>--enrich</code> for AI-powered classification (requires ANTHROPIC_API_KEY).</p>
          </div>
        </div>
        <div class="onboarding-step">
          <div class="step-number">3</div>
          <div class="step-content">
            <h3>Launch the dashboard</h3>
            <p>Start the server with <code>python3 server.py</code> and open
              <code>http://localhost:8080</code>. The dashboard will load automatically.</p>
          </div>
        </div>
      </div>

      <div class="onboarding-actions">
        <button class="btn-primary btn" onclick="attemptRescan()">Scan Now</button>
        <button class="btn" onclick="retryLoad()">Refresh</button>
      </div>
      <div class="onboarding-status" id="onboarding-status"></div>
    </div>`;
}

async function attemptRescan() {
  const status = document.getElementById('onboarding-status');
  status.textContent = 'Starting scan...';

  try {
    const resp = await fetch('/api/scan', { method: 'POST' });
    if (!resp.ok) {
      status.textContent = 'Server not running. Start with: python3 server.py';
      status.style.color = 'var(--red)';
      return;
    }
    status.textContent = 'Scanning repos... this may take a moment.';
    status.style.color = 'var(--yellow)';

    // Poll for completion
    const startTime = Date.now();
    const interval = setInterval(async () => {
      try {
        const check = await fetch('/api/status');
        if (check.ok) {
          const st = await check.json();
          if (st.status === 'idle') {
            clearInterval(interval);
            status.textContent = 'Scan complete! Loading dashboard...';
            status.style.color = 'var(--teal)';
            setTimeout(() => location.reload(), 500);
            return;
          }
        }
      } catch (_) { /* keep polling */ }

      if (Date.now() - startTime > 300000) {
        clearInterval(interval);
        status.textContent = 'Scan timed out. Try running python3 scan.py manually.';
        status.style.color = 'var(--red)';
      }
    }, 2000);
  } catch (_) {
    status.textContent = 'Could not reach server. Start with: python3 server.py';
    status.style.color = 'var(--red)';
  }
}

async function retryLoad() {
  const status = document.getElementById('onboarding-status');
  status.textContent = 'Checking for data...';
  status.style.color = 'var(--text-dim)';

  try {
    const resp = await fetch('data.json');
    if (resp.ok) {
      status.textContent = 'Data found! Loading dashboard...';
      status.style.color = 'var(--teal)';
      setTimeout(() => location.reload(), 300);
    } else {
      status.textContent = 'No data yet. Run python3 scan.py to generate it.';
      status.style.color = 'var(--yellow)';
    }
  } catch (_) {
    status.textContent = 'No data yet. Run python3 scan.py to generate it.';
    status.style.color = 'var(--yellow)';
  }
}

// ─── Countdown ──────────────────────────────────────────────────────────
function startCountdown(targetDateStr) {
  const target = new Date(targetDateStr + 'T00:00:00');

  function update() {
    const now = new Date();
    const diff = target - now;

    if (diff <= 0) {
      document.getElementById('countdown-days').textContent = '0';
      document.getElementById('countdown-full').textContent = 'GRADUATED';
      document.getElementById('countdown-full').style.color = '#4ecdc4';
      return;
    }

    const days = Math.floor(diff / 86400000);
    const hours = Math.floor((diff % 86400000) / 3600000);
    const mins = Math.floor((diff % 3600000) / 60000);
    const secs = Math.floor((diff % 60000) / 1000);

    document.getElementById('countdown-days').textContent = days;
    document.getElementById('countdown-full').textContent =
      `${days}d ${String(hours).padStart(2,'0')}h ${String(mins).padStart(2,'0')}m ${String(secs).padStart(2,'0')}s`;
  }

  update();
  setInterval(update, 1000);
}

// ─── Charts ─────────────────────────────────────────────────────────────
function getEpochMonth(data) {
  const first = data.monthly[0]?.month || '2025-06';
  return [parseInt(first.split('-')[0]), parseInt(first.split('-')[1]) - 1];
}

function renderCommitChart(data) {
  const monthly = data.monthly;
  const projection = data.models?.commit_rate?.projection || [];
  const epochMonth = getEpochMonth(data);

  const allLabels = [...monthly.map(m => m.month), ...projection.map(p => p.month)];
  const actualData = monthly.map(m => m.commits);

  const model = data.models?.commit_rate;
  const fittedLine = model ? allLabels.map((_, i) => {
    const ex = model.r * (i - model.t_mid);
    if (Math.abs(ex) > 50) return 0;
    const sig = 1 / (1 + Math.exp(-ex));
    return Math.round(model.L * model.r * sig * (1 - sig));
  }) : [];

  chartInstances.commits = new Chart(document.getElementById('chart-commits'), {
    type: 'bar',
    data: {
      labels: allLabels.map(l => l.substring(2)),
      datasets: [
        {
          label: 'Actual Commits',
          data: [...actualData, ...projection.map(() => null)],
          backgroundColor: 'rgba(255, 107, 107, 0.6)',
          borderColor: '#ff6b6b',
          borderWidth: 1,
        },
        {
          label: 'Model Fit + Projection',
          data: fittedLine,
          type: 'line',
          borderColor: '#ffd93d',
          borderWidth: 2,
          pointRadius: 0,
          tension: 0.4,
          fill: false,
        },
      ],
    },
    options: {
      ...CHART_DEFAULTS,
      plugins: {
        ...CHART_DEFAULTS.plugins,
        annotation: { annotations: makeMilestoneAnnotations(data, epochMonth, allLabels.length) },
      },
    },
  });
}

function renderCapabilityChart(data) {
  const monthly = data.monthly;
  const model = data.models?.capability;
  const projection = model?.projection || [];
  const epochMonth = getEpochMonth(data);

  const allLabels = [...monthly.map(m => m.month), ...projection.map(p => p.month)];
  const actualBars = [...monthly.map(m => m.cumulative_capability), ...projection.map(() => null)];

  const fittedLine = model ? allLabels.map((_, i) => {
    const ex = model.r * (i - model.t_mid);
    if (ex > 50) return model.L;
    if (ex < -50) return 0;
    return Math.round(model.L / (1 + Math.exp(-ex)));
  }) : [];

  const asymptoteLine = model ? allLabels.map(() => model.L) : [];

  // 95% and 99% horizontal lines
  const line95 = model ? allLabels.map(() => Math.round(model.L * 0.95)) : [];
  const line99 = model ? allLabels.map(() => Math.round(model.L * 0.99)) : [];

  const annotations = makeMilestoneAnnotations(data, epochMonth, allLabels.length);

  // Add horizontal bands for 95/99
  if (model) {
    annotations['h95'] = {
      type: 'line', yMin: model.L * 0.95, yMax: model.L * 0.95,
      borderColor: 'rgba(78, 205, 196, 0.5)', borderWidth: 1, borderDash: [4, 4],
      label: { display: true, content: '95%', position: 'end', backgroundColor: 'transparent', color: '#4ecdc4', font: { size: 9 } },
    };
    annotations['h99'] = {
      type: 'line', yMin: model.L * 0.99, yMax: model.L * 0.99,
      borderColor: 'rgba(88, 166, 255, 0.5)', borderWidth: 1, borderDash: [4, 4],
      label: { display: true, content: '99%', position: 'end', backgroundColor: 'transparent', color: '#58a6ff', font: { size: 9 } },
    };
  }

  const capDatasets = [
    {
      label: 'Cumulative Capability',
      data: actualBars,
      backgroundColor: 'rgba(78, 205, 196, 0.6)',
      borderColor: '#4ecdc4',
      borderWidth: 1,
      _scoringType: 'enriched',
    },
    {
      label: 'Logistic Fit',
      data: fittedLine,
      type: 'line',
      borderColor: '#58a6ff',
      borderWidth: 2,
      pointRadius: 0,
      tension: 0.4,
      fill: false,
    },
    {
      label: `Asymptote (L=${model?.L || '?'})`,
      data: asymptoteLine,
      type: 'line',
      borderColor: cssVar('--border'),
      borderWidth: 1,
      borderDash: [5, 5],
      pointRadius: 0,
      fill: false,
    },
  ];

  // Add regex overlay if dual-scoring data is available
  if (data.monthly_regex) {
    const rx = data.monthly_regex;
    capDatasets.push({
      label: 'Regex Cumulative Capability',
      data: [...rx.map(m => m.cumulative_capability), ...projection.map(() => null)],
      type: 'line',
      borderColor: cssVar('--yellow'),
      borderWidth: 2,
      borderDash: [6, 4],
      pointRadius: 0,
      tension: 0.4,
      fill: false,
      _scoringType: 'regex',
    });
  }

  chartInstances.capability = new Chart(document.getElementById('chart-capability'), {
    type: 'bar',
    data: { labels: allLabels.map(l => l.substring(2)), datasets: capDatasets },
    options: {
      ...CHART_DEFAULTS,
      plugins: {
        ...CHART_DEFAULTS.plugins,
        annotation: { annotations },
      },
    },
  });
}

function renderSophisticationChart(data) {
  const monthly = data.monthly;
  const model = data.models?.sophistication;
  const epochMonth = getEpochMonth(data);

  const labels = monthly.map(m => m.month);
  const actual = monthly.map(m => Math.round(m.sophistication * 100));

  const extendedLabels = [...labels];
  const trendline = [];
  for (let i = 0; i < labels.length + 6; i++) {
    if (i >= labels.length) {
      const yr = epochMonth[0] + Math.floor((epochMonth[1] + i) / 12);
      const mo = (epochMonth[1] + i) % 12;
      extendedLabels.push(`${yr}-${String(mo + 1).padStart(2, '0')}`);
    }
    if (model) {
      const val = Math.min(100, Math.max(0, (model.intercept + model.slope * i) * 100));
      trendline.push(Math.round(val));
    }
  }

  const actualPadded = [...actual, ...Array(extendedLabels.length - actual.length).fill(null)];

  const annotations = makeMilestoneAnnotations(data, epochMonth, extendedLabels.length);

  const sophDatasets = [
    {
      label: 'Sophistication %',
      data: actualPadded,
      borderColor: '#b380ff',
      backgroundColor: 'rgba(179, 128, 255, 0.2)',
      borderWidth: 2,
      pointRadius: 4,
      fill: true,
      _scoringType: 'enriched',
    },
    {
      label: 'Linear Trend',
      data: trendline,
      borderColor: '#ffd93d',
      borderWidth: 2,
      borderDash: [5, 5],
      pointRadius: 0,
      fill: false,
    },
    {
      label: '100% Threshold',
      data: extendedLabels.map(() => 100),
      borderColor: cssVar('--border'),
      borderWidth: 1,
      borderDash: [3, 3],
      pointRadius: 0,
      fill: false,
    },
  ];

  // Add regex overlay if dual-scoring data is available
  if (data.monthly_regex) {
    const rx = data.monthly_regex;
    const rxPadded = [...rx.map(m => Math.round(m.sophistication * 100)),
                      ...Array(extendedLabels.length - rx.length).fill(null)];
    sophDatasets.push({
      label: 'Regex Sophistication %',
      data: rxPadded,
      borderColor: cssVar('--yellow'),
      borderWidth: 2,
      borderDash: [6, 4],
      pointRadius: 3,
      pointBackgroundColor: cssVar('--yellow'),
      fill: false,
      _scoringType: 'regex',
    });
  }

  chartInstances.sophistication = new Chart(document.getElementById('chart-sophistication'), {
    type: 'line',
    data: { labels: extendedLabels.map(l => l.substring(2)), datasets: sophDatasets },
    options: {
      ...CHART_DEFAULTS,
      scales: {
        ...CHART_DEFAULTS.scales,
        y: { ...CHART_DEFAULTS.scales.y, min: 0, max: 110 },
      },
      plugins: {
        ...CHART_DEFAULTS.plugins,
        annotation: { annotations },
      },
    },
  });
}

function renderConvergenceChart(data) {
  const monthly = data.monthly;
  const crModel = data.models?.commit_rate;
  const capModel = data.models?.capability;
  const epochMonth = getEpochMonth(data);

  const allLabels = [];
  for (let i = 0; i < monthly.length + 8; i++) {
    const yr = epochMonth[0] + Math.floor((epochMonth[1] + i) / 12);
    const mo = (epochMonth[1] + i) % 12;
    allLabels.push(`${yr}-${String(mo + 1).padStart(2, '0')}`);
  }

  const peakCommits = Math.max(...monthly.map(m => m.commits));

  const commitPct = allLabels.map((_, i) => {
    if (i < monthly.length) {
      return Math.round(monthly[i].commits / peakCommits * 100);
    }
    if (crModel) {
      const ex = crModel.r * (i - crModel.t_mid);
      if (Math.abs(ex) > 50) return 0;
      const sig = 1 / (1 + Math.exp(-ex));
      const rate = crModel.L * crModel.r * sig * (1 - sig);
      return Math.max(0, Math.round(rate / peakCommits * 100));
    }
    return null;
  });

  const capPct = allLabels.map((_, i) => {
    if (capModel) {
      const ex = capModel.r * (i - capModel.t_mid);
      let sig;
      if (ex > 50) sig = 1;
      else if (ex < -50) sig = 0;
      else sig = 1 / (1 + Math.exp(-ex));
      return Math.round(sig * 100);
    }
    return null;
  });

  const annotations = makeMilestoneAnnotations(data, epochMonth, allLabels.length);

  // Add 95/99 horizontal lines
  annotations['h95_conv'] = {
    type: 'line', yMin: 95, yMax: 95,
    borderColor: 'rgba(78, 205, 196, 0.3)', borderWidth: 1, borderDash: [4, 4],
    label: { display: true, content: '95%', position: 'start', backgroundColor: 'transparent', color: '#4ecdc488', font: { size: 9 } },
  };

  chartInstances.convergence = new Chart(document.getElementById('chart-convergence'), {
    type: 'line',
    data: {
      labels: allLabels.map(l => l.substring(2)),
      datasets: [
        {
          label: 'Commit Rate (% of peak)',
          data: commitPct,
          borderColor: '#ff6b6b',
          backgroundColor: 'rgba(255, 107, 107, 0.1)',
          borderWidth: 2,
          pointRadius: 0,
          tension: 0.4,
          fill: true,
        },
        {
          label: 'Capability (% of self-sufficiency)',
          data: capPct,
          borderColor: '#4ecdc4',
          backgroundColor: 'rgba(78, 205, 196, 0.1)',
          borderWidth: 2,
          pointRadius: 0,
          tension: 0.4,
          fill: true,
        },
      ],
    },
    options: {
      ...CHART_DEFAULTS,
      scales: {
        ...CHART_DEFAULTS.scales,
        y: { ...CHART_DEFAULTS.scales.y, min: 0, max: 100 },
      },
      plugins: {
        ...CHART_DEFAULTS.plugins,
        annotation: { annotations },
      },
    },
  });
}

// ─── Drift Chart ────────────────────────────────────────────────────────
function renderDriftChart(data) {
  const history = data.convergence_history || [];
  if (history.length < 1) return;

  document.getElementById('drift-section').style.display = 'block';

  const labels = history.map(h => {
    const d = new Date(h.scan_time);
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  });

  const daysUntil = history.map(h => h.days_until_convergence);

  // Component date lines: convert each target date to "days from today at scan time"
  function dateToDaysFrom(targetDate, scanTime) {
    if (!targetDate) return null;
    const target = new Date(targetDate + 'T00:00:00');
    const scan = new Date(scanTime);
    scan.setHours(0,0,0,0);
    return Math.round((target - scan) / 86400000);
  }

  const commitZero = history.map(h => dateToDaysFrom(h.component_dates?.commit_zero, h.scan_time));
  const cap95 = history.map(h => dateToDaysFrom(h.component_dates?.capability_95, h.scan_time));
  const cap99 = history.map(h => dateToDaysFrom(h.component_dates?.capability_99, h.scan_time));
  const soph100 = history.map(h => dateToDaysFrom(h.component_dates?.sophistication_100, h.scan_time));

  // Trend summary
  if (history.length >= 2) {
    const first = daysUntil[0];
    const last = daysUntil[daysUntil.length - 1];
    const scans = history.length - 1;
    const drift = (first - last) / scans;
    const summaryEl = document.getElementById('drift-summary');
    if (drift > 0) {
      summaryEl.innerHTML = `Convergence is moving <strong style="color:var(--teal);">${drift.toFixed(1)} days closer</strong> per scan (${scans} scan${scans > 1 ? 's' : ''})`;
    } else if (drift < 0) {
      summaryEl.innerHTML = `Convergence is drifting <strong style="color:var(--red);">${Math.abs(drift).toFixed(1)} days further</strong> per scan (${scans} scan${scans > 1 ? 's' : ''})`;
    } else {
      summaryEl.innerHTML = `Convergence date is <strong>stable</strong> across ${scans} scan${scans > 1 ? 's' : ''}`;
    }
  }

  new Chart(document.getElementById('chart-drift'), {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: 'Days Until Convergence',
          data: daysUntil,
          borderColor: '#ffd93d',
          backgroundColor: 'rgba(255, 217, 61, 0.1)',
          borderWidth: 3,
          pointRadius: 5,
          pointBackgroundColor: '#ffd93d',
          fill: true,
          tension: 0.3,
        },
        {
          label: 'Commit Zero',
          data: commitZero,
          borderColor: '#ff6b6b',
          borderWidth: 1.5,
          borderDash: [6, 3],
          pointRadius: 3,
          fill: false,
          tension: 0.3,
        },
        {
          label: 'Capability 95%',
          data: cap95,
          borderColor: '#4ecdc4',
          borderWidth: 1.5,
          borderDash: [6, 3],
          pointRadius: 3,
          fill: false,
          tension: 0.3,
        },
        {
          label: 'Capability 99%',
          data: cap99,
          borderColor: '#58a6ff',
          borderWidth: 1.5,
          borderDash: [6, 3],
          pointRadius: 3,
          fill: false,
          tension: 0.3,
        },
        {
          label: 'Sophistication 100%',
          data: soph100,
          borderColor: '#b380ff',
          borderWidth: 1.5,
          borderDash: [6, 3],
          pointRadius: 3,
          fill: false,
          tension: 0.3,
        },
      ],
    },
    options: {
      ...CHART_DEFAULTS,
      plugins: {
        ...CHART_DEFAULTS.plugins,
        tooltip: {
          callbacks: {
            afterBody(items) {
              const idx = items[0]?.dataIndex;
              if (idx === undefined) return '';
              const h = history[idx];
              const lines = [];
              if (h.convergence_date) lines.push(`Target: ${h.convergence_date}`);
              if (h.pct_of_asymptote) lines.push(`Capability: ${h.pct_of_asymptote}%`);
              if (h.total_commits) lines.push(`Commits: ${h.total_commits.toLocaleString()}`);
              return lines.join('\n');
            },
          },
        },
      },
      scales: {
        ...CHART_DEFAULTS.scales,
        y: {
          ...CHART_DEFAULTS.scales.y,
          title: { display: true, text: 'Days remaining', color: cssVar('--text-dim'), font: { size: 11 } },
          reverse: false,
        },
      },
    },
  });
}

// ─── Issue Impact Table ─────────────────────────────────────────────────
function renderIssueImpactTable(data) {
  const issues = data.issue_scores;
  if (!issues || issues.length === 0) return;

  document.getElementById('issue-impact-section').style.display = 'block';
  const wrapper = document.getElementById('issue-impact-table-wrapper');

  const rows = issues.map(issue => {
    const impactClass = issue.convergence_impact_days < 0 ? 'positive' : 'neutral';
    const impactText = issue.convergence_impact_days < 0
      ? `${issue.convergence_impact_days}d`
      : issue.convergence_impact_days === 0 ? '0d' : `+${issue.convergence_impact_days}d`;

    const catTags = Object.keys(issue.categories || {})
      .map(c => `<span class="cat-tag">${c}</span>`)
      .join('');

    return `<tr>
      <td class="rank">${issue.priority_rank}</td>
      <td class="impact ${impactClass}">${impactText}</td>
      <td class="score">${issue.projected_score}</td>
      <td class="issue-title" title="${escapeHtml(issue.title)}">${escapeHtml(issue.title)}</td>
      <td class="repo-name">${escapeHtml(issue.repo)}#${issue.number}</td>
      <td class="cats">${catTags}</td>
    </tr>`;
  }).join('');

  wrapper.innerHTML = `<table class="issue-impact-table">
    <thead><tr>
      <th>#</th><th>Impact</th><th>Score</th><th>Issue</th><th>Repo</th><th>Categories</th>
    </tr></thead>
    <tbody>${rows}</tbody>
  </table>`;
}

// ─── Dual-Scoring Overlay ────────────────────────────────────────────────
let chartInstances = {};

function hasDualScoring() {
  return DATA && DATA.monthly_regex && DATA.monthly_regex.length > 0;
}

function updateScoringOverlays() {
  if (!hasDualScoring()) return;
  const showEnriched = document.getElementById('toggle-enriched').checked;
  const showRegex = document.getElementById('toggle-regex').checked;

  for (const [key, chart] of Object.entries(chartInstances)) {
    if (!chart) continue;
    for (const ds of chart.data.datasets) {
      if (ds._scoringType === 'enriched') {
        ds.hidden = !showEnriched;
      } else if (ds._scoringType === 'regex') {
        ds.hidden = !showRegex;
      }
    }
    chart.update();
  }
}

// ─── Init ───────────────────────────────────────────────────────────────
async function init() {
  DATA = await loadData();
  const data = DATA;

  // Enable export when data is available
  if (data) document.getElementById('btn-export').disabled = false;

  // Countdown
  const targetDate = data.models?.convergence_date || '2026-06-30';
  startCountdown(targetDate);
  const convDate = new Date(targetDate + 'T00:00:00');
  const formattedDate = convDate.toLocaleDateString('en-US', {
    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
  });
  document.getElementById('convergence-date').textContent = formattedDate;

  // Stats
  const pct = data.current?.pct_of_asymptote || 0;
  document.getElementById('stat-capability').textContent = `${pct.toFixed(1)}%`;
  document.getElementById('stat-sophistication').textContent =
    `${(data.current?.current_sophistication * 100 || 0).toFixed(0)}%`;
  document.getElementById('stat-commits').textContent =
    (data.current?.total_commits || 0).toLocaleString();
  document.getElementById('stat-repos').textContent = data.repos_scanned || '--';
  document.getElementById('stat-day').textContent = data.current?.days_since_inception || '--';

  // Progress bar
  const fill = document.getElementById('progress-fill');
  const bar = document.getElementById('progress-bar');
  setTimeout(() => {
    fill.style.width = `${Math.min(100, pct)}%`;
    fill.textContent = `${pct.toFixed(1)}%`;
    bar.setAttribute('aria-valuenow', Math.round(pct));
  }, 100);

  // Charts — wrap each in try/catch so partial data doesn't break everything
  try { renderDriftChart(data); } catch (e) { console.warn('Drift chart error:', e); }
  try { renderCommitChart(data); } catch (e) { console.warn('Commit chart error:', e); }
  try { renderCapabilityChart(data); } catch (e) { console.warn('Capability chart error:', e); }
  try { renderSophisticationChart(data); } catch (e) { console.warn('Sophistication chart error:', e); }
  try { renderConvergenceChart(data); } catch (e) { console.warn('Convergence chart error:', e); }
  try { renderIssueImpactTable(data); } catch (e) { console.warn('Issue impact table error:', e); }

  // Show scoring toggles if dual-scoring data is present
  if (hasDualScoring()) {
    document.getElementById('scoring-toggles').classList.add('active');
    const modeLabel = document.getElementById('scoring-mode-label');
    modeLabel.textContent = data.scoring_mode || 'enriched';
    modeLabel.style.color = cssVar('--teal');
  }

  // Footer
  const footer = document.getElementById('footer');
  const parts = [];
  if (data.generated) parts.push(`Last scan: ${data.generated}`);
  if (data.repos_scanned) parts.push(`${data.repos_scanned} repos`);
  if (data.total_commits) parts.push(`${data.total_commits.toLocaleString()} commits`);
  if (data.inception_date) parts.push(`Inception: ${data.inception_date}`);
  if (data.scoring_mode) parts.push(`Scoring: ${data.scoring_mode}`);
  footer.textContent = parts.join(' | ') || 'No scan data available';

  // Show warning banner for partial data
  if (data._partial) {
    footer.textContent += ' (partial data — some fields missing)';
  }
}

init();
</script>
</body>
</html>
